<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô</title>
    <script type="module">
        import {
            getFirestore, collection, doc, setDoc, getDocs,
            addDoc, updateDoc, query, where, serverTimestamp, orderBy
        } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpMbSik_WUBNLCAIYu7cvalMYLnNMOCYg",
            authDomain: "project-1acdd.firebaseapp.com",
            databaseURL: "https://project-1acdd-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "project-1acdd",
            storageBucket: "project-1acdd.appspot.com",
            messagingSenderId: "857000499734",
            appId: "1:857000499734:web:94c5c09f9ebf224e7db337",
            measurementId: "G-P7RZJD9P1G"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firestoreFunctions = {
            collection,
            doc,
            setDoc,
            getDocs,
            addDoc,
            updateDoc,
            query,
            where,
            serverTimestamp,
            orderBy
        };
    </script>
    <style>
        body {
            font-family: "Sarabun", sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
        }
        h2, h3, h4 {
            color: #2c3e50;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        input[type="text"] {
            padding: 10px;
            width: calc(100% - 24px);
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
        }
        button:hover {
            background-color: #1a252f;
        }
        ul { list-style: none; padding-left: 0; }
        li {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #eef2f5;
            border-radius: 6px;
            white-space: pre-line;
        }
        .section { margin-top: 30px; }
        .label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        .search-bar input { margin-bottom: 5px; }
        .footer {
            text-align: center;
            margin-top: 40px;
            font-size: 12px;
            color: #888;
        }
        #loginSection {
            max-width: 400px;
            margin: 100px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .logout-bar { text-align: right; }
        .borrowed-section {
            background: #fffbe7;
            border: 1.5px solid #ffe088;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 24px;
        }
        .note {
            color: #a78c20;
            margin-bottom: 0.5em;
            font-size: 13px;
        }
        /* Modal */
        #modalConfirm {
            display:none;
            position:fixed;
            z-index:9999;
            left:0; top:0;
            width:100vw; height:100vh;
            background:rgba(0,0,0,0.18);
            align-items:center; justify-content:center;
        }
        #modalConfirm.active { display: flex; }
        #modalConfirm .modal-box {
            background:#fff;
            padding:32px 22px 22px 22px;
            border-radius:12px;
            min-width:300px;
            text-align:center;
            box-shadow:0 10px 32px rgba(0,0,0,0.18);
            position: relative;
        }
        #modalConfirm .btn-confirm { background: #27ae60; }
        #modalConfirm .btn-cancel {
            background: #bdbdbd; color:#222; margin-left: 15px;
        }
    </style>
</head>
<body>
    <div id="loginSection" class="container">
        <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
        <label class="label">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
        <input type="text" id="inputName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£.‡∏ï.‡∏≠. ‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠ admin" />
        <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
    <div id="mainSection" class="container" style="display:none;">
        <div class="logout-bar">
            <button onclick="logout()" style="background:#e74c3c;margin-top:0;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô</h2>
        <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <span id="username"></span></p>
        <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡∏£‡∏ß‡∏à -->
        <div id="policeView" style="display:none;">
            <div class="section">
                <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡∏ô‡∏ß‡∏ô</h3>
                <label class="label">‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                <input type="text" id="caseNumber" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123/2566" />

                <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤:</label>
                <input type="text" id="suspectName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤" />

                <label class="label">‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢:</label>
                <input type="text" id="victimName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢" />

                <label class="label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô:</label>
                <input type="text" id="investigatorName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô" />

                <button onclick="saveBorrow()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
            </div>

            <div class="section borrowed-section">
                <h4>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà <button onclick="loadMyBorrows()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h4>
                <div class="note">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô)</div>
                <ul id="myRequests"></ul>
            </div>

            <div class="section borrowed-section">
                <h4>üîÑ ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô <button onclick="loadReturnable()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h4>
                <div class="note">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà</div>
                <ul id="returnableList"></ul>
            </div>

            <div class="section">
                <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô <button onclick="loadMyHistory()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h4>
                <ul id="myHistory"></ul>
            </div>
        </div>

        <!-- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô -->
        <div id="adminView" style="display:none;">
            <div class="section">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <button onclick="loadAllRequests()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h3>
                <div class="search-bar">
                    <label class="label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô:</label>
                    <input type="text" id="searchQuery" oninput="filterRequests()"
                           placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô" />
                </div>
                <ul id="allRequests"></ul>
            </div>
        </div>
        <div class="footer">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</div>
    </div>

    <!-- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô -->
    <div id="modalConfirm">
        <div class="modal-box">
            <div style="font-size:18px; margin-bottom:18px;">
                ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
            </div>
            <div>
                <button id="btnConfirmReturn" class="btn-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button onclick="closeModal()" class="btn-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
    <script>
        let name = null, isAdmin = false, isPolice = false;
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal
        let currentReturnDocId = null;

        function login() {
            const input = document.getElementById("inputName").value.trim();
            if (!input) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
                return;
            }
            name = input;
            localStorage.setItem("name", name);

            document.getElementById("loginSection").style.display = "none";
            document.getElementById("mainSection").style.display = "block";
            document.getElementById("username").innerText = name;

            isAdmin = name.toLowerCase().includes("admin");
            isPolice = !isAdmin;

            if (isPolice) {
                document.getElementById("policeView").style.display = "block";
                document.getElementById("adminView").style.display = "none";
                loadMyBorrows();
                loadReturnable();
                loadMyHistory();
            } else {
                document.getElementById("adminView").style.display = "block";
                document.getElementById("policeView").style.display = "none";
                loadAllRequests();
            }
        }

        function logout() {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                localStorage.removeItem("name");
                location.reload();
            }
        }

        window.onload = () => {
            const savedName = localStorage.getItem("name");
            if (savedName) {
                document.getElementById("inputName").value = savedName;
                login();
            }
        };

        async function saveBorrow() {
            const {
                collection,
                addDoc,
                query,
                where,
                getDocs,
                serverTimestamp
            } = window.firestoreFunctions;
            const db = window.db;
            const caseNumber = document.getElementById("caseNumber").value.trim();
            const suspect = document.getElementById("suspectName").value.trim();
            const victim = document.getElementById("victimName").value.trim();
            const investigator = document.getElementById("investigatorName").value.trim();
            const officer = localStorage.getItem("name") || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            if (!caseNumber || !suspect || !victim || !investigator) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");
                return;
            }
            const q = query(
                collection(db, "cases"),
                where("caseNumber", "==", caseNumber),
                where("status", "==", "borrowed")
            );
            const existing = await getDocs(q);
            if (!existing.empty) {
                alert("‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }
            await addDoc(collection(db, "cases"), {
                caseNumber,
                suspect,
                victim,
                investigator,
                officer,
                status: "borrowed",
                timestamp: serverTimestamp()
            });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            document.getElementById("caseNumber").value = '';
            document.getElementById("suspectName").value = '';
            document.getElementById("victimName").value = '';
            document.getElementById("investigatorName").value = '';
            loadMyBorrows();
            loadReturnable();
            loadMyHistory();
        }

        async function loadMyBorrows() {
            const {
                collection,
                getDocs,
                query,
                where,
                orderBy
            } = window.firestoreFunctions;
            const db = window.db;
            const list = document.getElementById("myRequests");
            list.innerHTML = '';
            const q = query(
                collection(db, "cases"),
                where("officer", "==", name),
                where("status", "==", "borrowed"),
                orderBy("timestamp", "desc")
            );
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                list.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà</li>';
                return;
            }
            snapshot.forEach(doc => {
                const b = doc.data();
                const borrowedAt = b.timestamp?.toDate().toLocaleString() || '-';
                const li = document.createElement("li");
                li.innerText = `‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏ô‡∏ß‡∏ô: ${b.caseNumber}, ‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤: ${b.suspect}, ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢: ${b.victim}, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô: ${b.investigator} üìå ‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà\nüïí ‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${borrowedAt}`;
                list.appendChild(li);
            });
        }

        async function loadReturnable() {
            const {
                collection,
                getDocs,
                query,
                where,
                orderBy
            } = window.firestoreFunctions;
            const db = window.db;
            const list = document.getElementById("returnableList");
            list.innerHTML = '';
            const q = query(
                collection(db, "cases"),
                where("officer", "==", name),
                where("status", "==", "borrowed"),
                orderBy("timestamp", "desc")
            );
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                list.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô</li>';
                return;
            }
            snapshot.forEach(docSnap => {
                const b = docSnap.data();
                const li = document.createElement("li");
                li.innerText = `‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏ô‡∏ß‡∏ô: ${b.caseNumber}, ‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤: ${b.suspect}, ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢: ${b.victim}`;
                const btn = document.createElement("button");
                btn.textContent = "‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô";
                btn.style.marginLeft = "10px";
                btn.onclick = () => returnCase(docSnap.id);
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        // ==== Modal Return Case ====
        function openModal(docId) {
            currentReturnDocId = docId;
            document.getElementById("modalConfirm").classList.add("active");
        }
        function closeModal() {
            document.getElementById("modalConfirm").classList.remove("active");
            currentReturnDocId = null;
        }
        async function doReturnCase() {
            if (!currentReturnDocId) return;
            const {
                doc,
                updateDoc,
                serverTimestamp
            } = window.firestoreFunctions;
            const db = window.db;
            await updateDoc(doc(db, "cases", currentReturnDocId), {
                status: "returned",
                returnedAt: serverTimestamp()
            });
            closeModal();
            alert("‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            loadMyBorrows();
            loadReturnable();
            loadMyHistory();
            if (isAdmin) loadAllRequests();
        }
        function returnCase(docId) {
            openModal(docId);
        }

        // ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á event ‡∏õ‡∏∏‡πà‡∏° confirm ‡πÉ‡∏ô modal (‡∏´‡∏•‡∏±‡∏á DOM ‡πÇ‡∏´‡∏•‡∏î)
        document.addEventListener("DOMContentLoaded", function () {
            const btn = document.getElementById('btnConfirmReturn');
            if (btn) btn.onclick = doReturnCase;
        });

        async function loadMyHistory() {
            const {
                collection,
                getDocs,
                query,
                where,
                orderBy
            } = window.firestoreFunctions;
            const db = window.db;
            const list = document.getElementById("myHistory");
            list.innerHTML = '';
            let q, snapshot;
            try {
                q = query(
                    collection(db, "cases"),
                    where("officer", "==", name),
                    where("status", "==", "returned"),
                    orderBy("timestamp", "desc")
                );
                snapshot = await getDocs(q);
            } catch (e) {
                if (e.code === 'failed-precondition' && e.message && e.message.includes('index')) {
                    list.innerHTML = `<li>‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á composite index ‡∏ó‡∏µ‡πà Firestore!<br>${e.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/gi)}</li>`;
                    return;
                } else {
                    list.innerHTML = `<li>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î<br>${e.message}</li>`;
                    return;
                }
            }
            if (snapshot.empty) {
                list.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</li>';
                return;
            }
            snapshot.forEach(doc => {
                const record = doc.data();
                const statusText = record.status === "borrowed" ? "üìå ‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà" : "‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
                const borrowedDate = record.timestamp?.toDate().toLocaleString() || '-';
                const returnedDate = record.returnedAt ? ` ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${record.returnedAt.toDate().toLocaleString()}` : "";
                const li = document.createElement("li");
                li.innerText = `‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏ô‡∏ß‡∏ô: ${record.caseNumber}, ‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤: ${record.suspect}, ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢: ${record.victim}, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô: ${record.investigator} (${statusText})\nüïí ‡∏¢‡∏∑‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${borrowedDate}${returnedDate}`;
                list.appendChild(li);
            });
        }

        async function loadAllRequests() {
            const {
                collection,
                getDocs,
                query,
                orderBy
            } = window.firestoreFunctions;
            const db = window.db;
            const list = document.getElementById("allRequests");
            list.innerHTML = '';
            const q = query(
                collection(db, "cases"),
                orderBy("timestamp", "desc")
            );
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                list.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>';
                return;
            }
            snapshot.forEach(doc => {
                const req = doc.data();
                const li = document.createElement("li");
                li.textContent = `‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏ô‡∏ß‡∏ô: ${req.caseNumber}, ‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤: ${req.suspect}, ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢: ${req.victim}, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô: ${req.investigator} (${req.status === "borrowed" ? "üìå ‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà" : "‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß"})`;
                li.dataset.suspect = (req.suspect || "").toLowerCase();
                li.dataset.investigator = (req.investigator || "").toLowerCase();
                list.appendChild(li);
            });
        }

        function filterRequests() {
            const query = document.getElementById("searchQuery").value.toLowerCase();
            const items = document.querySelectorAll("#allRequests li");
            items.forEach(li => {
                const suspect = li.dataset.suspect;
                const investigator = li.dataset.investigator;
                const show = query === '' || suspect.includes(query) || investigator.includes(query);
                li.style.display = show ? "block" : "none";
            });
        }
    </script>
</body>
</html>
